# Render.com deployment configuration for AlSign Financial Data API
# https://render.com/docs/blueprint-spec

services:
  # Backend API Service
  - type: web
    name: alsign-api
    runtime: python
    plan: starter # Free tier, upgrade to standard/pro for production
    region: oregon # Choose: oregon, frankfurt, singapore
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && uvicorn src.main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PYTHON_VERSION
        value: 3.11
      - key: DATABASE_URL
        fromDatabase:
          name: alsign-db
          property: connectionString
      - key: LOG_LEVEL
        value: INFO
      - key: CORS_ORIGINS
        value: "*" # Update to specific frontend URL in production
      - key: FMP_API_KEY
        sync: false # Set manually in Render dashboard (secret)
    healthCheckPath: /health
    autoDeploy: true

  # Frontend Static Site (optional - can use Vercel/Netlify instead)
  - type: web
    name: alsign-frontend
    runtime: static
    plan: starter
    region: oregon
    buildCommand: cd frontend && npm install && npm run build
    staticPublishPath: frontend/dist
    envVars:
      - key: VITE_API_BASE_URL
        value: https://alsign-api.onrender.com # Update with actual backend URL
    routes:
      - type: rewrite
        source: /*
        destination: /index.html # SPA fallback
    autoDeploy: true

# Database
databases:
  - name: alsign-db
    plan: starter # Free tier: 256MB RAM, 1GB disk, max 100 connections
    region: oregon # Must match backend region for low latency
    databaseName: alsign
    user: alsign_user
    ipAllowList: [] # Empty = allow all (default for Render apps)
    # For production, consider adding IP restrictions

# Notes:
# 1. Free tier limitations:
#    - Web services: 750 hours/month (can spin down after 15min inactivity)
#    - Database: 90 days expiration (upgrade to paid for persistence)
#    - No custom domains on free tier
#
# 2. Environment variables to set manually in Render dashboard:
#    - FMP_API_KEY: Your Financial Modeling Prep API key
#    - Any other API keys from config_lv1_api_service
#
# 3. Database initialization:
#    - After first deploy, run database migrations/schema setup
#    - Use Render Shell or connect via psql to run backend/src/database/schema.sql
#    - Populate config tables (config_lv0_policy, config_lv1_*, config_lv2_*, config_lv3_*)
#
# 4. Deployment workflow:
#    - Push to main branch -> auto-deploy (if autoDeploy: true)
#    - Or manually deploy from Render dashboard
#
# 5. Monitoring:
#    - Check logs in Render dashboard
#    - Health endpoint: https://alsign-api.onrender.com/health
#    - API docs: https://alsign-api.onrender.com/docs
#
# 6. Scaling:
#    - Upgrade to Standard ($7/month) for:
#      - Always-on (no spin down)
#      - Custom domains
#      - More resources
#    - Upgrade database to Standard ($7/month) for:
#      - No expiration
#      - Daily backups
#      - More storage/connections
