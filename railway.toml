# Railway deployment configuration for monorepo
# Uses Nixpacks builder to install backend dependencies, build frontend, and start FastAPI

[build]
builder = "NIXPACKS"
# Install Python tooling, create an isolated virtual environment, install backend deps,
# and build the frontend with Node 20.
buildCommand = "apt-get update && apt-get install -y python3 python3-venv python3-pip curl && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs && PIP_BREAK_SYSTEM_PACKAGES=1 python3 -m venv /app/.venv && /app/.venv/bin/python -m pip install --no-cache-dir -r backend/requirements.txt && cd frontend && npm ci && npm run build"

[deploy]
# Health endpoint exposed by backend
healthcheckPath = "/health"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3
# Use bash to avoid exec-bit issues on the repo file
startCommand = "bash ./start.sh"
