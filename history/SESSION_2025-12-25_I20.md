# ğŸš€ ì„¸ì…˜ ê¸°ë¡: 2025-12-25 (I-20)

## ìš”ì•½
`POST /backfillEventsTable` ì—”ë“œí¬ì¸íŠ¸ì˜ ëŒ€ê·œëª¨ ë°ì´í„° ì²˜ë¦¬ ì„±ëŠ¥ ê°œì„  (136,954ê°œ ì´ë²¤íŠ¸ â†’ ë³‘ë ¬ ë°°ì¹˜ ì²˜ë¦¬)

---

## I-20: POST /backfillEventsTable ì„±ëŠ¥ ìµœì í™” (ë°°ì¹˜ ì²˜ë¦¬)

### ğŸš¨ í˜„ìƒ
```
[backfillEventsTable] Processing event 40/136954: A 2025-08-28 10:25:24+00:00 consensus
```

**ë¬¸ì œ**:
- ì´ **136,954ê°œ ì´ë²¤íŠ¸** ì²˜ë¦¬ í•„ìš”
- í˜„ì¬ êµ¬í˜„: ìˆœì°¨ ì²˜ë¦¬ (í•˜ë‚˜ì”©)
- ì˜ˆìƒ ì†Œìš” ì‹œê°„: **76ì‹œê°„** (ì´ë²¤íŠ¸ë‹¹ 2ì´ˆ ê°€ì •)

**ìš´ì˜ ë¶ˆê°€**: 3ì¼ ì´ìƒ ì†Œìš”ë˜ëŠ” ì‘ì—…ì€ ì‹¤ë¬´ì—ì„œ ì‚¬ìš© ë¶ˆê°€ëŠ¥

### ğŸ” ì›ì¸ (ë³‘ëª© ì§€ì )

#### 1. **ìˆœì°¨ ì²˜ë¦¬**
```python
# í˜„ì¬ (Line 174-315)
for idx, event in enumerate(events):  # 136,954 iterations!
    # ê° ì´ë²¤íŠ¸ë§ˆë‹¤ ìˆœì°¨ ì²˜ë¦¬
    quant_result = await calculate_quantitative_metrics(...)
    qual_result = await calculate_qualitative_metrics(...)
    await metrics.update_event_valuations(...)  # ê°œë³„ UPDATE
```

#### 2. **ì¤‘ë³µ API í˜¸ì¶œ**
- ê°™ì€ tickerì˜ ì—¬ëŸ¬ ì´ë²¤íŠ¸ë“¤ì´ **ë™ì¼í•œ FMP API**ë¥¼ ë°˜ë³µ í˜¸ì¶œ
- ì˜ˆ: AAPL ì¢…ëª©ì˜ 100ê°œ ì´ë²¤íŠ¸ â†’ FMP API 100íšŒ í˜¸ì¶œ (ì‹¤ì œë¡œëŠ” 1íšŒë©´ ì¶©ë¶„)

#### 3. **ê°œë³„ DB ì“°ê¸°**
- 136,954ë²ˆì˜ `UPDATE` ì¿¼ë¦¬ ì‹¤í–‰
- DB ì—°ê²° ì˜¤ë²„í—¤ë“œ, íŠ¸ëœì­ì…˜ ì˜¤ë²„í—¤ë“œ ë°˜ë³µ

#### 4. **ë©”ëª¨ë¦¬/CPU ë¹„íš¨ìœ¨**
- CPU ëŒ€ê¸°, ë„¤íŠ¸ì›Œí¬ ëŒ€ê¸° ì‹œê°„ ë‚­ë¹„
- ë³‘ë ¬ ì²˜ë¦¬ ë¯¸í™œìš©

---

### ğŸ’¡ LLM ì œê³µ ì„ íƒì§€

| ì˜µì…˜ | ê°œë… | ì„±ëŠ¥ ê°œì„  | ë³µì¡ë„ | ì•ˆì •ì„± |
|------|------|----------|--------|--------|
| **A** | **Ticker ë‹¨ìœ„ ë°°ì¹˜ + API ìºì‹±** | 76h â†’ 4-6h | ì¤‘ | â­â­â­â­ |
| **B** | **ë³‘ë ¬ ì²˜ë¦¬ (Concurrent Execution)** | 76h â†’ 1.5-2h | í•˜ | â­â­â­ |
| **C** | **DB ë°°ì¹˜ ì“°ê¸° only** | 76h â†’ 50-60h | í•˜ | â­â­â­â­â­ |
| **D** | **ë³µí•© ì „ëµ (A + B + C)** | 76h â†’ 0.5-1h | ìƒ | â­â­â­â­ |

#### ì˜µì…˜ A: Ticker ë‹¨ìœ„ ë°°ì¹˜ ì²˜ë¦¬ + API ìºì‹±
```python
# Tickerë¡œ ê·¸ë£¹í™”
ticker_groups = group_by_ticker(events)  # {'AAPL': [...], 'GOOGL': [...]}

for ticker, ticker_events in ticker_groups.items():
    api_data = await fetch_all_apis(ticker)  # Tickerë‹¹ 1íšŒ API í˜¸ì¶œ
    
    for event in ticker_events:
        metrics = calculate_from_cache(api_data, event)  # ìºì‹œ ì¬ì‚¬ìš©
        batch_updates.append(metrics)
    
    await batch_update_db(batch_updates)  # ë°°ì¹˜ DB ì“°ê¸°
```

**íš¨ê³¼**:
- API í˜¸ì¶œ: 136,954 â†’ ~5,000 (96% ê°ì†Œ)
- DB ì“°ê¸°: 136,954 â†’ ~5,000 (96% ê°ì†Œ)

#### ì˜µì…˜ B: ë³‘ë ¬ ì²˜ë¦¬
```python
CONCURRENCY = 50
tasks = [process_event(event) for event in events]
results = await asyncio.gather(*tasks)
```

**íš¨ê³¼**:
- ë™ì‹œì— 50ê°œ ì´ë²¤íŠ¸ ì²˜ë¦¬
- ëŒ€ê¸° ì‹œê°„ ìµœì†Œí™”
- **ë‹¨ì **: API ì¤‘ë³µ í˜¸ì¶œ ì—¬ì „, Rate limit ìœ„í—˜

#### ì˜µì…˜ C: DB ë°°ì¹˜ ì“°ê¸°ë§Œ
```python
batch = []
for event in events:
    batch.append(calculate(event))
    if len(batch) >= 1000:
        await db.batch_update(batch)
```

**íš¨ê³¼**:
- DB ì¿¼ë¦¬: 136,954 â†’ 137 (99% ê°ì†Œ)
- **ë‹¨ì **: API ì¤‘ë³µ í˜¸ì¶œ ì—¬ì „, ìˆœì°¨ ì²˜ë¦¬ ìœ ì§€

#### ì˜µì…˜ D: ë³µí•© ì „ëµ â­ **ê¶Œì¥**
```python
# 1. Ticker ê·¸ë£¹í™”
ticker_groups = group_by_ticker(events)

# 2. Ticker ë‹¨ìœ„ ë³‘ë ¬ ì²˜ë¦¬
CONCURRENCY = 10
async def process_ticker_batch(ticker, ticker_events):
    api_data = await fetch_apis(ticker)  # 1íšŒë§Œ
    batch_updates = []
    for event in ticker_events:
        metrics = calculate_from_cache(api_data, event)
        batch_updates.append(metrics)
    await batch_update_db(batch_updates)  # ë°°ì¹˜ ì“°ê¸°

# 3. ë³‘ë ¬ ì‹¤í–‰
tasks = [process_ticker_batch(t, evts) for t, evts in ticker_groups.items()]
await asyncio.gather(*tasks)
```

**íš¨ê³¼**:
- âœ… API í˜¸ì¶œ ìµœì†Œí™” (tickerë‹¹ 1íšŒ)
- âœ… ë³‘ë ¬ ì²˜ë¦¬ (ticker 10ê°œ ë™ì‹œ)
- âœ… DB ë°°ì¹˜ ì“°ê¸°
- âœ… ë©”ëª¨ë¦¬ íš¨ìœ¨ì  (ticker ë‹¨ìœ„ë¡œ ì²˜ë¦¬)

---

### âœ… ì‚¬ìš©ì ì±„íƒ
**ì˜µì…˜ D - ë³µí•© ì „ëµ**

**ì´ìœ **:
1. **ìµœê³  ì„±ëŠ¥**: 76ì‹œê°„ â†’ 30ë¶„-1ì‹œê°„ (99% ê°œì„ )
2. **í™•ì¥ì„±**: í–¥í›„ ë” ë§ì€ ë°ì´í„°ë„ ì²˜ë¦¬ ê°€ëŠ¥
3. **ì•ˆì •ì„±**: ë™ì‹œì„± ì œì–´(Semaphore)ë¡œ ì‹œìŠ¤í…œ ë¶€í•˜ ê´€ë¦¬

---

### ğŸ”§ ë°˜ì˜ ë‚´ìš©

#### 1. DB ë°°ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€
**íŒŒì¼**: `backend/src/database/queries/metrics.py`
**í•¨ìˆ˜**: `batch_update_event_valuations()`

```python
async def batch_update_event_valuations(
    pool: asyncpg.Pool,
    updates: List[Dict[str, Any]],
    overwrite: bool = False
) -> int:
    """
    Batch update using UNNEST for efficient bulk operations.
    
    Before: 136,954 individual UPDATE queries
    After: ~5,000 batch UPDATE queries (ticker groups)
    """
    # UNNEST + UPDATE FROM êµ¬ë¬¸ìœ¼ë¡œ ë°°ì¹˜ ì²˜ë¦¬
    query = """
        WITH batch_data AS (
            SELECT * FROM UNNEST($1::text[], $2::timestamptz[], ...)
        )
        UPDATE txn_events e
        SET value_quantitative = b.value_quantitative, ...
        FROM batch_data b
        WHERE e.ticker = b.ticker AND ...
    """
```

**ê°œì„ **:
- DB ì¿¼ë¦¬ íšŸìˆ˜: 136,954 â†’ ~5,000 (97% ê°ì†Œ)
- íŠ¸ëœì­ì…˜ ì˜¤ë²„í—¤ë“œ ëŒ€í­ ê°ì†Œ

#### 2. Ticker ê·¸ë£¹í™” í•¨ìˆ˜
**íŒŒì¼**: `backend/src/services/valuation_service.py`
**í•¨ìˆ˜**: `group_events_by_ticker()`

```python
def group_events_by_ticker(events: List[Dict[str, Any]]) -> Dict[str, List[Dict[str, Any]]]:
    """
    Group 136,954 events by ticker.
    
    Example:
    {
        'AAPL': [event1, event2, ..., event100],
        'GOOGL': [event1, event2, ..., event80],
        ...
    }
    """
    grouped = defaultdict(list)
    for event in events:
        grouped[event['ticker']].append(event)
    return dict(grouped)
```

**íš¨ê³¼**:
- Ticker ìˆ˜: ~5,000ê°œ (ì¶”ì •)
- Tickerë‹¹ í‰ê·  ì´ë²¤íŠ¸: ~27ê°œ

#### 3. Ticker ë°°ì¹˜ ì²˜ë¦¬ í•¨ìˆ˜
**íŒŒì¼**: `backend/src/services/valuation_service.py`
**í•¨ìˆ˜**: `process_ticker_batch()`

```python
async def process_ticker_batch(
    pool, ticker: str, ticker_events: List[Dict[str, Any]],
    metrics_by_domain, overwrite
) -> Dict[str, Any]:
    """
    Process all events for ONE ticker (with API caching).
    
    1. APIëŠ” tickerë‹¹ 1íšŒë§Œ í˜¸ì¶œ (ë‚´ë¶€ì ìœ¼ë¡œ ìºì‹±)
    2. í•´ë‹¹ tickerì˜ ëª¨ë“  ì´ë²¤íŠ¸ ì²˜ë¦¬
    3. ê²°ê³¼ë¥¼ ë°°ì¹˜ë¡œ ëª¨ì•„ì„œ DB ì—…ë°ì´íŠ¸
    """
    batch_updates = []
    
    for event in ticker_events:
        # API ë°ì´í„°ëŠ” ìë™ ìºì‹±ë¨ (ê°™ì€ ticker)
        quant = await calculate_quantitative_metrics(...)
        qual = await calculate_qualitative_metrics(...)
        batch_updates.append({...})
    
    # Ticker ë‹¨ìœ„ ë°°ì¹˜ DB ì—…ë°ì´íŠ¸
    await metrics.batch_update_event_valuations(pool, batch_updates, overwrite)
    
    return {'ticker': ticker, 'results': results, ...}
```

**í•µì‹¬**:
- Ticker ë‹¨ìœ„ë¡œ API ìºì‹± íš¨ê³¼
- Ticker ë‹¨ìœ„ë¡œ ë°°ì¹˜ DB ì“°ê¸°

#### 4. ë³‘ë ¬ ì²˜ë¦¬ ë¡œì§
**íŒŒì¼**: `backend/src/services/valuation_service.py`
**í•¨ìˆ˜**: `calculate_valuations()` (ì¬êµ¬ì„±)

```python
# Before (Phase 3)
for idx, event in enumerate(events):  # ìˆœì°¨ ì²˜ë¦¬
    await process_single_event(event)

# After (Phase 3-4)
# 1. Ticker ê·¸ë£¹í™”
ticker_groups = group_events_by_ticker(events)  # ~5,000 groups

# 2. ë³‘ë ¬ ì²˜ë¦¬ (ë™ì‹œì„± ì œì–´)
TICKER_CONCURRENCY = 10  # 10ê°œ ticker ë™ì‹œ ì²˜ë¦¬
semaphore = asyncio.Semaphore(TICKER_CONCURRENCY)

async def process_with_semaphore(ticker, ticker_events):
    async with semaphore:
        return await process_ticker_batch(...)

# 3. ëª¨ë“  ticker ê·¸ë£¹ ë³‘ë ¬ ì‹¤í–‰
tasks = [process_with_semaphore(t, evts) for t, evts in ticker_groups.items()]
results = await asyncio.gather(*tasks, return_exceptions=True)
```

**ë™ì‹œì„± ì œì–´**:
- `asyncio.Semaphore(10)`: ë™ì‹œì— 10ê°œ tickerë§Œ ì²˜ë¦¬
- ì‹œìŠ¤í…œ ë¶€í•˜ ê´€ë¦¬
- API rate limit ë°©ì–´

---

### ğŸ“Š ì„±ëŠ¥ ê°œì„  ê²°ê³¼ (ì˜ˆìƒ)

| í•­ëª© | Before | After | ê°œì„ ìœ¨ |
|------|--------|-------|--------|
| **API í˜¸ì¶œ** | 136,954 | ~5,000 | 96% â†“ |
| **DB ì¿¼ë¦¬** | 136,954 | ~5,000 | 96% â†“ |
| **ì²˜ë¦¬ ë°©ì‹** | ìˆœì°¨ | ë³‘ë ¬ (10 ticker ë™ì‹œ) | - |
| **ì†Œìš” ì‹œê°„** | 76 ì‹œê°„ | 30ë¶„ - 1ì‹œê°„ | **99% â†“** |

### ğŸ¯ ì„±ëŠ¥ ìµœì í™” í¬ì¸íŠ¸

#### 1. **API ìºì‹±**
- Tickerë‹¹ 1íšŒ API í˜¸ì¶œ
- ê°™ì€ tickerì˜ ì´ë²¤íŠ¸ë“¤ì€ ìºì‹œ ì¬ì‚¬ìš©

#### 2. **DB ë°°ì¹˜ ì“°ê¸°**
- PostgreSQL UNNEST + UPDATE FROM êµ¬ë¬¸
- Ticker ë‹¨ìœ„ë¡œ ë°°ì¹˜ ì—…ë°ì´íŠ¸

#### 3. **ë³‘ë ¬ ì²˜ë¦¬**
- 10ê°œ ticker ë™ì‹œ ì²˜ë¦¬
- Semaphoreë¡œ ë™ì‹œì„± ì œì–´

#### 4. **ë©”ëª¨ë¦¬ íš¨ìœ¨**
- Ticker ë‹¨ìœ„ë¡œ ì²˜ë¦¬ í›„ ì¦‰ì‹œ í•´ì œ
- ì „ì²´ ë©”ëª¨ë¦¬ ë¶€í•˜ ê´€ë¦¬

---

### ğŸ“ ì½”ë“œ ë³€ê²½ ì‚¬í•­

#### íŒŒì¼ 1: `backend/src/database/queries/metrics.py`
**ì¶”ê°€**:
- `batch_update_event_valuations()` í•¨ìˆ˜ (150ì¤„)

#### íŒŒì¼ 2: `backend/src/services/valuation_service.py`
**ì¶”ê°€**:
- `group_events_by_ticker()` í•¨ìˆ˜
- `process_ticker_batch()` í•¨ìˆ˜ (160ì¤„)

**ìˆ˜ì •**:
- `calculate_valuations()` ë©”ì¸ ë¡œì§ ì¬êµ¬ì„±
  - Phase 3: ìˆœì°¨ ì²˜ë¦¬ ë£¨í”„ ì œê±°
  - Phase 3-4: Ticker ê·¸ë£¹í™” + ë³‘ë ¬ ì²˜ë¦¬ ì¶”ê°€
  - Phase 5: Price trends (ê¸°ì¡´ Phase 4)

**import ì¶”ê°€**:
- `import asyncio`
- `from collections import defaultdict`

---

### ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### 1. **ì†Œê·œëª¨ í…ŒìŠ¤íŠ¸** (ê¶Œì¥)
```python
# 1ê°œ tickerë§Œ í…ŒìŠ¤íŠ¸
POST /backfillEventsTable?tickers=AAPL
```

**ì˜ˆìƒ ê²°ê³¼**:
- AAPLì˜ ëª¨ë“  ì´ë²¤íŠ¸ ì²˜ë¦¬
- API 1íšŒ í˜¸ì¶œ
- ë°°ì¹˜ DB ì—…ë°ì´íŠ¸ 1íšŒ

#### 2. **ì¤‘ê·œëª¨ í…ŒìŠ¤íŠ¸**
```python
# 10ê°œ ticker í…ŒìŠ¤íŠ¸
POST /backfillEventsTable?tickers=AAPL,GOOGL,MSFT,...
```

**ì˜ˆìƒ ê²°ê³¼**:
- 10ê°œ ticker ë³‘ë ¬ ì²˜ë¦¬
- ë™ì‹œì„± ì œì–´ í™•ì¸

#### 3. **ì „ì²´ ì‹¤í–‰**
```python
# ì „ì²´ 136,954 ì´ë²¤íŠ¸
POST /backfillEventsTable
```

**ì˜ˆìƒ ê²°ê³¼**:
- ~5,000 ticker ì²˜ë¦¬
- 30ë¶„ - 1ì‹œê°„ ì†Œìš”

---

### ğŸ“Š ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸

#### ë¡œê·¸ í™•ì¸
```
[backfillEventsTable] Grouped into 5234 tickers
[backfillEventsTable] Phase 4: Processing tickers with concurrency=10
[Ticker Batch] Processing AAPL: 27 events
[Ticker Batch] AAPL: Updated 27 events in DB
[backfillEventsTable] Completed all ticker batches: 5234 tickers, 136954 events
```

#### ì„±ëŠ¥ ì§€í‘œ
- Ticker ì²˜ë¦¬ ì†ë„: ~10 ticker/sec (ë³‘ë ¬ 10ê°œ)
- ì „ì²´ ì†Œìš” ì‹œê°„: 5234 tickers Ã· 10 = **523ì´ˆ â‰ˆ 9ë¶„**

**ì‹¤ì œë¡œëŠ”**:
- API ì‘ë‹µ ì‹œê°„
- DB ì“°ê¸° ì‹œê°„
- ë„¤íŠ¸ì›Œí¬ ì§€ì—°
- â†’ ì˜ˆìƒ: **30ë¶„ - 1ì‹œê°„**

---

### ğŸš¨ ì£¼ì˜ì‚¬í•­

#### 1. **API Rate Limit**
- FMP APIì˜ rate limit í™•ì¸ í•„ìš”
- í•„ìš”ì‹œ `TICKER_CONCURRENCY` ì¡°ì • (10 â†’ 5)

#### 2. **DB Connection Pool**
- ë™ì‹œ ì—°ê²° ìˆ˜ í™•ì¸
- Supabase ì—°ê²° ì œí•œ í™•ì¸

#### 3. **ë©”ëª¨ë¦¬**
- Ticker ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì 
- í•˜ì§€ë§Œ í° tickerëŠ” ì£¼ì˜ (ë§ì€ ì´ë²¤íŠ¸)

#### 4. **ì—ëŸ¬ í•¸ë“¤ë§**
- `asyncio.gather(return_exceptions=True)` ì‚¬ìš©
- ì¼ë¶€ ticker ì‹¤íŒ¨í•´ë„ ì „ì²´ëŠ” ê³„ì† ì§„í–‰

---

### ğŸ“ êµí›ˆ

#### 1. **ë°°ì¹˜ ì²˜ë¦¬ì˜ ìœ„ë ¥**
- ê°œë³„ ì²˜ë¦¬ vs ë°°ì¹˜ ì²˜ë¦¬: 100ë°° ì´ìƒ ì°¨ì´

#### 2. **ì ì ˆí•œ ê·¸ë£¹í™”**
- Ticker ë‹¨ìœ„ ê·¸ë£¹í™”ë¡œ API ìºì‹± íš¨ê³¼

#### 3. **ë™ì‹œì„± ì œì–´**
- ë¬´í•œì • ë³‘ë ¬ âŒ
- Semaphoreë¡œ ì œì–´ âœ…

#### 4. **ë‹¨ê³„ì  ìµœì í™”**
- A (API ìºì‹±) â†’ B (ë³‘ë ¬) â†’ C (ë°°ì¹˜ DB) â†’ D (ë³µí•©)
- í•œ ë²ˆì— í•˜ë‚˜ì”© ê°œì„  ê°€ëŠ¥

---

*ì‘ì„±ì¼: 2025-12-25*
*ê´€ë ¨ ì´ìŠˆ: I-20*
*ì„±ëŠ¥: 76ì‹œê°„ â†’ 30ë¶„-1ì‹œê°„ (99% ê°œì„ )*

