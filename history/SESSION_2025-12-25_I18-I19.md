# ğŸ”§ ì„¸ì…˜ ê¸°ë¡: 2025-12-25 (I-18, I-19)

## ìš”ì•½
ì´ ì„¸ì…˜ì—ì„œëŠ” `priceEodOHLC` ë©”íŠ¸ë¦­ì˜ schema array type ë¬¸ì œ(I-18)ì™€ ë¡œê·¸ truncation ë¬¸ì œ(I-19)ë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

---

## I-18: priceEodOHLC Schema Array Type ë¬¸ì œ

### ğŸš¨ í˜„ìƒ
```
[MetricEngine] Failed to calculate priceEodOHLC: unhashable type: 'list'
```

**ì¦ìƒ ì§„í–‰ ê³¼ì •**:
1. ì´ˆê¸°: `[priceEodOHLC] No API data` (fromDate/toDate ëˆ„ë½)
2. ìˆ˜ì • í›„: `local variable 'event_date_obj' referenced before assignment` 
3. ìˆ˜ì • í›„: `unhashable type: 'list'` â† **I-18**

### ğŸ” ì›ì¸

**ì—ëŸ¬ ë°œìƒ ìœ„ì¹˜**: `metric_engine.py:74`
```python
def get_required_apis(self) -> Set[str]:
    api_ids = set()
    for metric in self.all_metrics:
        api_list_id = metric.get('api_list_id')
        if api_list_id and metric.get('source') == 'api_field':
            api_ids.add(api_list_id)  # âŒ listë¥¼ setì— ì¶”ê°€ ì‹œë„!
    return api_ids
```

**ê·¼ë³¸ ì›ì¸**: DBì˜ `config_lv1_api_list.schema` ì»¬ëŸ¼ì´ **array `[{}]`** íƒ€ì…ìœ¼ë¡œ ì €ì¥ë¨

```sql
-- ì˜ëª»ëœ ì €ì¥
schema = '[{"low": "low", "high": "high", ...}]'::jsonb  -- array type

-- ì˜¬ë°”ë¥¸ ì €ì¥
schema = '{"low": "low", "high": "high", ...}'::jsonb    -- object type
```

**ë¬¸ì œ íë¦„**:
1. `config_lv1_api_list.schema` â†’ `[{}]` (array)
2. `external_api.py`ì—ì„œ schema íŒŒì‹± ì‹œ â†’ `schema.items()` í˜¸ì¶œ
3. âŒ `AttributeError: 'list' object has no attribute 'items'`

ë˜í•œ:
1. `config_lv2_metric.api_list_id` â†’ `["fmp-..."]` (array?)
2. `metric_engine.py`ì—ì„œ `api_ids.add(api_list_id)` í˜¸ì¶œ
3. âŒ `TypeError: unhashable type: 'list'`

### ğŸ’¡ LLM ì œê³µ ì„ íƒì§€

**A. ë‹¨ì¼ API ìˆ˜ì •** (config_lv1_api_listì˜ fmp-historical-price-eod-fullë§Œ)
- ì¥ì : ë¹ ë¥¸ ìˆ˜ì •
- ë‹¨ì : ë‹¤ë¥¸ APIì— ë™ì¼ ë¬¸ì œ ì¡´ì¬ ê°€ëŠ¥

**B. ì „ì²´ API ê²€ì¦ + ìˆ˜ì •** (19ê°œ API ëª¨ë‘ ê²€ì¦)
- ì¥ì : ì‹œìŠ¤í…œ ì „ì²´ ì•ˆì •ì„± í™•ë³´
- ë‹¨ì : ì‹œê°„ ì†Œìš”

### âœ… ì‚¬ìš©ì ì±„íƒ
**ì˜µì…˜ B** - ì „ì²´ API ê²€ì¦ í›„ ì¼ê´„ ìˆ˜ì •

**ì´ìœ **: 
- ë™ì¼ ë¬¸ì œê°€ ë‹¤ë¥¸ APIì—ë„ ìˆì„ ê°€ëŠ¥ì„±
- í•œ ë²ˆì˜ ìˆ˜ì •ìœ¼ë¡œ ëª¨ë“  array type ë¬¸ì œ í•´ê²°
- í–¥í›„ ìœ ì‚¬ ë¬¸ì œ ë°©ì§€

### ğŸ”§ ë°˜ì˜ ë‚´ìš©

#### 1. ì§„ë‹¨ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
**íŒŒì¼**: `backend/scripts/diagnose_priceEodOHLC_issue.sql`
```sql
-- config_lv2_metric.api_list_id íƒ€ì… í™•ì¸
-- config_lv2_metric.response_key íƒ€ì… í™•ì¸  
-- config_lv1_api_list.schema íƒ€ì… í™•ì¸
```

#### 2. ì „ì²´ API ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
**íŒŒì¼**: `backend/scripts/verify_all_api_schemas.sql`
```sql
SELECT 
    api,
    jsonb_typeof(schema) as schema_type,
    CASE 
        WHEN jsonb_typeof(schema) = 'array' THEN 'ERROR: Schema is array'
        WHEN jsonb_typeof(schema) = 'object' THEN 'OK'
        ELSE 'UNKNOWN'
    END as status
FROM config_lv1_api_list;
```

**ê²€ì¦ ê²°ê³¼**:
- âŒ 1ê°œ API: `fmp-historical-price-eod-full` (array type)
- âœ… 18ê°œ API: ëª¨ë‘ object type

#### 3. ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸
**íŒŒì¼**: `backend/scripts/fix_priceEodOHLC_array_types.sql`
```sql
-- Fix 1: api_list_id array â†’ string
UPDATE config_lv2_metric
SET api_list_id = 'fmp-historical-price-eod-full'
WHERE id = 'priceEodOHLC'
  AND api_list_id::text LIKE '[%';

-- Fix 2: response_key array â†’ object
UPDATE config_lv2_metric
SET response_key = '{"low": "low", "high": "high", "open": "open", "close": "close"}'::jsonb
WHERE id = 'priceEodOHLC'
  AND jsonb_typeof(response_key) = 'array';

-- Fix 3: schema array â†’ object
UPDATE config_lv1_api_list
SET schema = '{"symbol": "ticker", "date": "date", ...}'::jsonb
WHERE api = 'https://financialmodelingprep.com/stable/historical-price-eod/full?...'
  AND jsonb_typeof(schema) = 'array';
```

#### 4. í†µí•© ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
**íŒŒì¼**: `backend/scripts/EXECUTE_FIX_SEQUENCE.sql`
- Step 1: ë¬¸ì œ í™•ì¸ (BEFORE)
- Step 2: ìˆ˜ì • ì ìš©
- Step 3: ìˆ˜ì • ê²€ì¦ (AFTER)
- Step 4: ì „ì²´ API ìµœì¢… ê²€ì¦

### ğŸ¯ ê²°ê³¼
```sql
-- Before
schema_type: array âŒ
status: ERROR

-- After  
schema_type: object âœ…
status: OK
```

### ğŸ“ êµí›ˆ
- **JSONB íƒ€ì… ì£¼ì˜**: `[{}]` vs `{}`ëŠ” ì™„ì „íˆ ë‹¤ë¥¸ íƒ€ì…
- **ì „ì²´ ê²€ì¦ì˜ ì¤‘ìš”ì„±**: í•˜ë‚˜ì˜ ë¬¸ì œëŠ” ë‹¤ë¥¸ ê³³ì—ë„ ì¡´ì¬ ê°€ëŠ¥
- **DB ìŠ¤í‚¤ë§ˆ ì¼ê´€ì„±**: ëª¨ë“  APIì˜ schemaëŠ” object íƒ€ì…ì´ì–´ì•¼ í•¨

---

## I-19: ë©”íŠ¸ë¦­ ë¡œê·¸ Truncation ë¬¸ì œ

### ğŸš¨ í˜„ìƒ
```
[MetricEngine] âœ“ priceEodOHLC = [{'low': 15.48, 'high': 16.37, 'open': 15.65, 'clo (source: api_field)
                                                                              ^^^^ ì˜ë¦¼!
```

**ë¬¸ì œ**: `close` í•„ë“œì˜ ê°’ì´ `'clo`ê¹Œì§€ë§Œ í‘œì‹œë˜ê³  ì˜ë¦¼

### ğŸ” ì›ì¸

**ì—ëŸ¬ ë°œìƒ ìœ„ì¹˜**: `metric_engine.py:261`
```python
logger.info(f"[MetricEngine] âœ“ {metric_name} = {str(value)[:50]} (source: ...)")
                                                          ^^^^^ 50ìë¡œ ìë¦„!
```

**ì¶”ê°€ ë¬¸ì œ**:
- ë¶ˆí•„ìš”í•œ ë””ë²„ê¹… ë¡œê·¸ ê³¼ë‹¤ (priceEodOHLC ì „ìš© warning ë¡œê·¸ë“¤)
- ë¦¬ìŠ¤íŠ¸ ë©”íŠ¸ë¦­ì˜ ê²½ìš° ì²« í•­ëª©ë§Œ ë³´ê³ ë„ ì „ì²´ ìƒíƒœ íŒŒì•… ì–´ë ¤ì›€

### ğŸ’¡ LLM ì œê³µ ì„ íƒì§€

**A. ë‹¨ìˆœ ê¸¸ì´ ì¦ê°€** (50 â†’ 100ì)
- ì¥ì : ê°„ë‹¨í•œ ìˆ˜ì •
- ë‹¨ì : ì—¬ì „íˆ ì˜ë¦´ ê°€ëŠ¥ì„±, ê¸´ ë¦¬ìŠ¤íŠ¸ëŠ” ì—¬ì „íˆ ë¬¸ì œ

**B. ìŠ¤ë§ˆíŠ¸ í¬ë§·íŒ…**
- ë¦¬ìŠ¤íŠ¸: ì²« í•­ëª© + ê°œìˆ˜ í‘œì‹œ
- ìŠ¤ì¹¼ë¼: ì „ì²´ ê°’ í‘œì‹œ
- ì•ˆì „ì¥ì¹˜: 150ì ì œí•œ
- ì¥ì : ê°€ë…ì„± í–¥ìƒ, ì •ë³´ëŸ‰ ìµœì í™”
- ë‹¨ì : ë¡œì§ ë³µì¡ë„ ì¦ê°€

**C. ë¡œê·¸ ë ˆë²¨ë³„ ë¶„ë¦¬**
- INFO: ìš”ì•½ (ê°œìˆ˜ë§Œ)
- DEBUG: ì „ì²´ ê°’
- ì¥ì : í™˜ê²½ë³„ ì œì–´ ê°€ëŠ¥
- ë‹¨ì : ì¼ë°˜ì ì¸ ë””ë²„ê¹…ì´ ì–´ë ¤ì›€

### âœ… ì‚¬ìš©ì ì±„íƒ
**ì˜µì…˜ B** - ìŠ¤ë§ˆíŠ¸ í¬ë§·íŒ…

**ì´ìœ **:
- ë¦¬ìŠ¤íŠ¸ì™€ ìŠ¤ì¹¼ë¼ë¥¼ êµ¬ë¶„í•˜ì—¬ ìµœì  í‘œì‹œ
- í•œ ì¤„ì— í•„ìš”í•œ ì •ë³´ ëª¨ë‘ í¬í•¨
- ë¡œê·¸ ê°€ë…ì„± í–¥ìƒ

### ğŸ”§ ë°˜ì˜ ë‚´ìš©

#### 1. ìŠ¤ë§ˆíŠ¸ í¬ë§·íŒ… ë¡œì§
**íŒŒì¼**: `backend/src/services/metric_engine.py:258-271`

```python
# Before
logger.info(f"[MetricEngine] âœ“ {metric_name} = {str(value)[:50]} (source: ...)")

# After
if isinstance(value, list) and len(value) > 0:
    first_item = value[0]
    value_str = f"[{first_item}, ...] ({len(value)} items)"
else:
    value_str = str(value)

if len(value_str) > 150:
    value_str = value_str[:150] + "..."

logger.info(f"[MetricEngine] âœ“ {metric_name} = {value_str} (source: ...)")
```

#### 2. ë¶ˆí•„ìš”í•œ ë””ë²„ê·¸ ë¡œê·¸ ì œê±°
**íŒŒì¼**: `backend/src/services/metric_engine.py:431-473`

**ì œê±°ëœ ë¡œê·¸**:
- `[priceEodOHLC] Dict response_key processing...`
- `[priceEodOHLC] First record keys...`
- `[priceEodOHLC] First record sample...`
- `[priceEodOHLC] Extracted ... dicts...`
- `[priceEodOHLC] First result...`

**ì´ìœ **: 
- ì´ì œ ìŠ¤ë§ˆíŠ¸ í¬ë§·íŒ…ìœ¼ë¡œ ì¶©ë¶„í•œ ì •ë³´ ì œê³µ
- ë¡œê·¸ ë…¸ì´ì¦ˆ ê°ì†Œ
- ì¼ë°˜ debug ë¡œê·¸ë¡œ ëŒ€ì²´

### ğŸ¯ ê²°ê³¼

#### Before
```
[priceEodOHLC] Dict response_key processing: field_key={...}, api_response type=<class 'list'>, len=1082
[priceEodOHLC] First record keys: ['symbol', 'date', 'open', 'high', 'low', 'close', 'volume', ...]
[priceEodOHLC] First record sample: {'symbol': 'RGTI', 'date': '2025-08-12', 'open': 15.65, ...}
[priceEodOHLC] Extracted 1082 dicts from 1082 records
[priceEodOHLC] First result: {'low': 15.48, 'high': 16.37, 'open': 15.65, 'close': 16.2}
[MetricEngine] âœ“ priceEodOHLC = [{'low': 15.48, 'high': 16.37, 'open': 15.65, 'clo (source: api_field)
```

#### After
```
[MetricEngine] âœ“ priceEodOHLC = [{'low': 15.48, 'high': 16.37, 'open': 15.65, 'close': 16.2}, ...] (1082 items) (source: api_field)
```

**ê°œì„  íš¨ê³¼**:
- âœ… 6ì¤„ â†’ 1ì¤„ (ë¡œê·¸ ë…¸ì´ì¦ˆ 83% ê°ì†Œ)
- âœ… `close` ê°’ ì™„ì „íˆ í‘œì‹œ
- âœ… ì´ ê°œìˆ˜ í‘œì‹œë¡œ ë°ì´í„° ê·œëª¨ íŒŒì•… ê°€ëŠ¥
- âœ… ì²« í•­ëª©ì˜ ëª¨ë“  í•„ë“œ í™•ì¸ ê°€ëŠ¥

### ğŸ“ ë¡œê·¸ ì˜ë¯¸ ì„¤ëª…

```
[MetricEngine] âœ“ priceEodOHLC = [{'low': 1.26, 'high': 1.34, 'open': 1.3, 'close': 1.28}, ...] (768 items) (source: api_field)
```

**êµ¬ì„± ìš”ì†Œ**:
- `âœ“`: ë©”íŠ¸ë¦­ ê³„ì‚° ì„±ê³µ
- `priceEodOHLC`: ë©”íŠ¸ë¦­ ì´ë¦„ (OHLC ê°€ê²© ë°ì´í„°)
- `[{...}, ...]`: ë¦¬ìŠ¤íŠ¸ í˜•íƒœì˜ ê°’
  - `low: 1.26`: ìµœì €ê°€
  - `high: 1.34`: ìµœê³ ê°€  
  - `open: 1.3`: ì‹œê°€
  - `close: 1.28`: ì¢…ê°€
  - `...`: ë‚˜ë¨¸ì§€ í•­ëª©ë“¤ (í‘œì‹œ ìƒëµ)
- `(768 items)`: ì´ 768ê°œì˜ ì¼ë³„ OHLC ë°ì´í„°
- `(source: api_field)`: FMP APIì—ì„œ ì§ì ‘ ì¶”ì¶œí•œ í•„ë“œ

**ì˜ë¯¸**: 
- RGTI ì¢…ëª©ì˜ **768ì¼ì¹˜ ì¼ë³„ ê°€ê²© ë°ì´í„°**ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì¡°íšŒ
- ì²« ë²ˆì§¸ ë‚ ì˜ ê°€ê²©: ì‹œê°€ $1.3, ê³ ê°€ $1.34, ì €ê°€ $1.26, ì¢…ê°€ $1.28
- ì´ ë°ì´í„°ëŠ” `fmp-historical-price-eod-full` APIì—ì„œ ê°€ì ¸ì˜´
- ì´í›„ `price_trend` ê³„ì‚°ì— ì‚¬ìš©ë¨

---

## ì—°ê´€ ê´€ê³„

```
I-13 (priceEodOHLC API íŒŒë¼ë¯¸í„° ëˆ„ë½)
  â†“
I-15 (event_date_obj ìˆœì„œ ì˜¤ë¥˜)
  â†“
I-18 (schema array type ë¬¸ì œ) â† ì´ë²ˆ ì„¸ì…˜
  â†“
I-19 (ë¡œê·¸ truncation ë¬¸ì œ) â† ì´ë²ˆ ì„¸ì…˜
  â†“
âœ… priceEodOHLC ì™„ì „ í•´ê²°!
```

## íŒŒì¼ ëª©ë¡

### ìƒì„±ëœ íŒŒì¼
1. `backend/scripts/diagnose_priceEodOHLC_issue.sql` - ì§„ë‹¨
2. `backend/scripts/verify_all_api_schemas.sql` - ì „ì²´ ê²€ì¦
3. `backend/scripts/fix_priceEodOHLC_array_types.sql` - ìˆ˜ì •
4. `backend/scripts/EXECUTE_FIX_SEQUENCE.sql` - í†µí•© ì‹¤í–‰

### ìˆ˜ì •ëœ íŒŒì¼
1. `backend/src/services/metric_engine.py` - ìŠ¤ë§ˆíŠ¸ í¬ë§·íŒ… + ë¡œê·¸ ì •ë¦¬

---

*ì‘ì„±ì¼: 2025-12-25*
*ê´€ë ¨ ì´ìŠˆ: I-18, I-19*

