# Data Model: History Page with Trade Performance Calculations

**Date**: 2026-01-16
**Feature**: 001-history-performance-page

## Entities

### 1. Trade (existing)

**Source**: `txn_trades` table

| Field | Type | Description |
|-------|------|-------------|
| ticker | string | Stock symbol (e.g., "AAPL") |
| trade_date | date | Entry date (YYYY-MM-DD) |
| position | enum | "long" or "short" |
| model | string | Trading model identifier |
| source | string | Data source |
| entry_price | decimal | Entry price (nullable) |
| exit_price | decimal | Exit price (nullable) |
| quantity | integer | Number of shares (nullable) |
| notes | text | Free-form notes (nullable) |

### 2. Historical Price (existing)

**Source**: `config_lv3_quantitatives.historical_price` (JSONB)

| Field | Type | Description |
|-------|------|-------------|
| date | string | Trading date (YYYY-MM-DD) |
| open | decimal | Opening price |
| high | decimal | High price |
| low | decimal | Low price |
| close | decimal | Closing price |

**Structure**: Array of OHLC records or `{ historical: [...] }` wrapper

### 3. Performance Settings (new - localStorage)

**Storage Key**: `ui.history_settings`

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| baseOffset | integer | 0 | Base day offset (0-14) |
| baseField | enum | "close" | OHLC field: open/high/low/close |
| minThreshold | number | null | MIN% threshold (e.g., -10 for -10%) |
| maxThreshold | number | null | MAX% threshold (e.g., 20 for +20%) |

### 4. History State (new - localStorage)

**Storage Key**: `ui.history_state`

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| selectedColumns | string[] | (default columns) | Visible column keys |
| filters | object | {} | Column filter values |
| sort | object | { key: 'trade_date', direction: 'desc' } | Sort configuration |
| dayOffsetMode | enum | "performance" | Display mode: performance/price_trend |

### 5. History Cache Token (new - localStorage)

**Storage Key**: `ui.history_cache_token`

| Field | Type | Description |
|-------|------|-------------|
| token | number | Timestamp for cache invalidation |

### 6. Calculated Performance (computed)

**Generated by**: historyData.js `computeHistoryRows()`

| Field | Type | Description |
|-------|------|-------------|
| d_0 through d_pos14 | decimal | Performance value per day offset |
| day_offset_performance | object | Map of dayKey → performance value |
| day_offset_target_dates | object | Map of dayKey → actual date |
| day_offset_price_trend | object | Map of dayKey → price value |
| day_offset_price_trend_open | object | Map of dayKey → open price |
| day_offset_price_trend_high | object | Map of dayKey → high price |
| day_offset_price_trend_low | object | Map of dayKey → low price |
| day_offset_price_trend_close | object | Map of dayKey → close price |
| wts | integer | "When To Sell" - day offset with best performance |
| is_blurred | boolean | Whether data is hidden (always false for history) |

## Relationships

```
Trade (txn_trades)
  └── ticker ──matches──> Historical Price (config_lv3_quantitatives)

Performance Settings (localStorage)
  └── controls ──> Calculated Performance computation

History State (localStorage)
  └── controls ──> UI rendering (columns, filters, sort)
```

## State Transitions

### Settings Change Flow

```
User changes setting in Dashboard
  ↓
setHistorySettings() called
  ↓
requestHistoryCacheRefresh() invalidates cache
  ↓
All subscribed listeners notified
  ↓
HistoryPage triggers loadHistoryDataset()
  ↓
computeHistoryRows() uses new settings
  ↓
UI re-renders with new calculations
```

### Threshold Stop Flow

```
For each trade, for each day D0-D14:
  ↓
Calculate perfLow, perfHigh, perfClose
  ↓
Check MIN% threshold first (stop loss priority)
  ↓
If MIN% breached: mark stop, set subsequent days to null
  ↓
Else check MAX% threshold
  ↓
If MAX% breached: mark stop, set subsequent days to null
  ↓
Else: record perfClose as day value
```

## Validation Rules

| Field | Rule |
|-------|------|
| baseOffset | Must be integer 0-14 |
| baseField | Must be one of: open, high, low, close |
| minThreshold | Must be number <= 0 or null (disabled) |
| maxThreshold | Must be number >= 0 or null (disabled) |
| ticker | Must exist in historical_price data for calculations |
| trade_date | Must exist in ticker's date list for D0 calculation |
