-- ============================================================================
-- AlSign Financial Data API - Supabase Database Setup
-- ============================================================================
--
-- Instructions:
-- 1. Open Supabase Dashboard (https://fgypclaqxonwxlmqdphx.supabase.co)
-- 2. Go to SQL Editor
-- 3. Copy and paste this entire script
-- 4. Click "Run" to execute
--
-- This script is idempotent - safe to run multiple times
-- ============================================================================

-- ============================================================================
-- STEP 1: Create ENUM Types
-- ============================================================================

DO $$ BEGIN
    CREATE TYPE public.position AS ENUM ('long', 'short', 'neutral');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE public.metric_source AS ENUM ('api_field', 'aggregation', 'expression');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE public.metric_transform_type AS ENUM ('aggregation', 'transformation');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;


-- ============================================================================
-- STEP 2: Create Trigger Functions
-- ============================================================================

-- Function to validate metric API field
CREATE OR REPLACE FUNCTION validate_metric_api_field()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.source = 'api_field' AND NEW.api_list_id IS NULL THEN
        RAISE EXCEPTION 'api_list_id is required when source is api_field';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to populate metric response key from response path
CREATE OR REPLACE FUNCTION populate_metric_response_key()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.response_key IS NULL AND NEW.response_path IS NOT NULL THEN
        NEW.response_key := to_jsonb(string_to_array(NEW.response_path, '.'));
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


-- ============================================================================
-- STEP 3: Create Config Tables (Level 0)
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.config_lv0_policy (
    endpoint text NULL,
    function text NOT NULL,
    description text NULL,
    policy jsonb NULL,
    created_at timestamp with time zone NOT NULL DEFAULT NOW(),
    CONSTRAINT config_lv0_policy_pkey PRIMARY KEY (function)
);


-- ============================================================================
-- STEP 4: Create Config Tables (Level 1)
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.config_lv1_api_service (
    created_at timestamp with time zone NOT NULL DEFAULT NOW(),
    api_service text NOT NULL,
    "apiKey" text NULL,
    "usagePerMin" smallint NULL,
    CONSTRAINT config_lv1_api_service_pkey PRIMARY KEY (api_service)
);

CREATE TABLE IF NOT EXISTS public.config_lv1_api_list (
    id text NOT NULL,
    api_service text NULL,
    api text NULL,
    schema jsonb NULL,
    endpoint text NULL,
    function2 text NULL,
    created_at timestamp with time zone NULL DEFAULT NOW(),
    CONSTRAINT config_api_list_pkey PRIMARY KEY (id),
    CONSTRAINT config_api_list_api_service_fkey FOREIGN KEY (api_service)
        REFERENCES config_lv1_api_service (api_service)
);


-- ============================================================================
-- STEP 5: Create Config Tables (Level 2)
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.config_lv2_metric_transform (
    id text NOT NULL,
    transform_type public.metric_transform_type NOT NULL DEFAULT 'aggregation'::metric_transform_type,
    description text NOT NULL,
    input_kind text NOT NULL,
    output_kind text NOT NULL,
    params_schema jsonb NOT NULL DEFAULT '{}'::jsonb,
    example_params jsonb NOT NULL DEFAULT '{}'::jsonb,
    version integer NOT NULL DEFAULT 1,
    is_active boolean NOT NULL DEFAULT true,
    created_at timestamp with time zone NULL DEFAULT NOW(),
    CONSTRAINT config_lv1_metric_transform_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.config_lv2_metric (
    id text NOT NULL,
    description text NULL,
    source public.metric_source NOT NULL,
    api_list_id text NULL,
    base_metric_id text NULL,
    aggregation_kind text NULL,
    aggregation_params jsonb NULL DEFAULT '{}'::jsonb,
    expression text NULL,
    domain text NULL,
    created_at timestamp with time zone NULL DEFAULT NOW(),
    response_path text NULL,
    response_key jsonb NULL,
    CONSTRAINT config_lv2_metric_pkey PRIMARY KEY (id),
    CONSTRAINT config_lv2_metric_api_list_id_fkey FOREIGN KEY (api_list_id)
        REFERENCES config_lv1_api_list (id) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT config_lv2_metric_base_metric_id_fkey FOREIGN KEY (base_metric_id)
        REFERENCES config_lv2_metric (id),
    CONSTRAINT fk_metric_aggregation_kind FOREIGN KEY (aggregation_kind)
        REFERENCES config_lv2_metric_transform (id),
    CONSTRAINT config_lv2_metric_source_consistency_check CHECK (
        (
            (source = 'api_field'::metric_source AND api_list_id IS NOT NULL AND response_key IS NOT NULL)
            OR (source = 'aggregation'::metric_source AND aggregation_kind IS NOT NULL)
            OR (source = 'expression'::metric_source AND expression IS NOT NULL)
        )
    )
);

-- Create index on config_lv2_metric for performance
CREATE INDEX IF NOT EXISTS idx_config_lv2_metric_sort_desc
ON public.config_lv2_metric USING btree (source DESC, api_list_id DESC, created_at DESC);

-- Create triggers on config_lv2_metric
DROP TRIGGER IF EXISTS trg_validate_metric_api_field ON config_lv2_metric;
CREATE TRIGGER trg_validate_metric_api_field
BEFORE INSERT OR UPDATE ON config_lv2_metric
FOR EACH ROW EXECUTE FUNCTION validate_metric_api_field();

DROP TRIGGER IF EXISTS trg_populate_metric_response_key ON config_lv2_metric;
CREATE TRIGGER trg_populate_metric_response_key
BEFORE INSERT OR UPDATE ON config_lv2_metric
FOR EACH ROW EXECUTE FUNCTION populate_metric_response_key();


-- ============================================================================
-- STEP 6: Create Config Tables (Level 3)
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.config_lv3_market_holidays (
    exchange text NOT NULL,
    date date NOT NULL,
    name text NULL,
    is_closed boolean NULL,
    adj_open_time text NULL,
    adj_close_time text NULL,
    is_fully_closed boolean NULL,
    updated_at timestamp with time zone NULL DEFAULT NOW(),
    CONSTRAINT config_lv3_market_holidays_pkey PRIMARY KEY (exchange, date)
);

-- Create trigger for updated_at on market_holidays
DROP TRIGGER IF EXISTS trg_update_market_holidays_updated_at ON config_lv3_market_holidays;
CREATE TRIGGER trg_update_market_holidays_updated_at
BEFORE UPDATE ON config_lv3_market_holidays
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TABLE IF NOT EXISTS public.config_lv3_targets (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    ticker text NOT NULL,
    sector text NULL,
    industry text NULL,
    response_key jsonb NOT NULL,
    updated_at timestamp without time zone NULL DEFAULT NOW(),
    CONSTRAINT config_lv3_targets_pkey PRIMARY KEY (ticker)
);

-- Create trigger for updated_at on targets
DROP TRIGGER IF EXISTS trg_update_targets_updated_at ON config_lv3_targets;
CREATE TRIGGER trg_update_targets_updated_at
BEFORE UPDATE ON config_lv3_targets
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TABLE IF NOT EXISTS public.config_lv3_analyst (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    analyst_name text NULL,
    analyst_company text NULL,
    analyst_name_key text GENERATED ALWAYS AS (COALESCE(analyst_name, '__NULL__')) STORED,
    analyst_company_key text GENERATED ALWAYS AS (COALESCE(analyst_company, '__NULL__')) STORED,
    performance jsonb NOT NULL,
    updated_at timestamp without time zone NULL DEFAULT NOW(),
    CONSTRAINT config_lv3_analyst_pkey PRIMARY KEY (id),
    CONSTRAINT config_lv3_analyst_uniq_key UNIQUE (analyst_name_key, analyst_company_key)
);

-- Create trigger for updated_at on analyst
DROP TRIGGER IF EXISTS trg_update_analyst_updated_at ON config_lv3_analyst;
CREATE TRIGGER trg_update_analyst_updated_at
BEFORE UPDATE ON config_lv3_analyst
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();


-- ============================================================================
-- STEP 7: Create Event Tables
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.evt_consensus (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    ticker text NOT NULL,
    event_date timestamp with time zone NOT NULL,
    analyst_name text NULL,
    analyst_company text NULL,
    price_target numeric NULL,
    price_when_posted numeric NULL,
    price_target_prev numeric NULL,
    price_when_posted_prev numeric NULL,
    direction text NULL,
    response_key jsonb NULL,
    created_at timestamp with time zone NOT NULL DEFAULT NOW(),
    CONSTRAINT evt_consensus_pkey PRIMARY KEY (id),
    CONSTRAINT evt_consensus_unique_news UNIQUE (ticker, event_date, analyst_name, analyst_company)
);

CREATE TABLE IF NOT EXISTS public.evt_earning (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    ticker text NOT NULL,
    event_date timestamp with time zone NOT NULL,
    response_key jsonb NULL,
    created_at timestamp with time zone NOT NULL DEFAULT NOW(),
    CONSTRAINT evt_earning_pkey PRIMARY KEY (id),
    CONSTRAINT evt_earning_unique UNIQUE (ticker, event_date)
);


-- ============================================================================
-- STEP 8: Create Transaction Table
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.txn_events (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    ticker text NOT NULL,
    event_date timestamp with time zone NOT NULL,
    sector text NULL,
    industry text NULL,
    source text NOT NULL,
    source_id text NOT NULL,
    value_quantitative jsonb NULL,
    position_quantitative public.position NULL,
    disparity_quantitative numeric NULL,
    value_qualitative jsonb NULL,
    position_qualitative public.position NULL,
    disparity_qualitative numeric NULL,
    price_trend jsonb NULL,
    analyst_performance jsonb NULL,
    condition text NULL,
    created_at timestamp with time zone NOT NULL DEFAULT NOW(),
    CONSTRAINT txn_events_pkey PRIMARY KEY (id),
    CONSTRAINT txn_events_uniq UNIQUE (ticker, event_date, source, source_id)
);


-- ============================================================================
-- STEP 9: Seed Initial Data
-- ============================================================================

BEGIN;

-- 1) API services
INSERT INTO public.config_lv1_api_service (created_at, api_service, "apiKey", "usagePerMin") VALUES ('2025-12-04 09:26:32+00', 'financialmodelingprep', '8AP6lUDNsrBwtx5IzVoDliKnG186rBSt', 300) ON CONFLICT (api_service) DO UPDATE SET "apiKey"=EXCLUDED."apiKey", "usagePerMin"=EXCLUDED."usagePerMin";
INSERT INTO public.config_lv1_api_service (created_at, api_service, "apiKey", "usagePerMin") VALUES ('2025-12-09 08:25:38+00', 'internal', NULL, NULL) ON CONFLICT (api_service) DO UPDATE SET "apiKey"=EXCLUDED."apiKey", "usagePerMin"=EXCLUDED."usagePerMin";

-- 2) API list
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-aftermarket-trade', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/aftermarket-trade?symbol={ticker}?apikey={apiKey}', '{"ticker":"symbol","tradeSize":"tradeSize","priceAfter":"price","UTCtimestamp":"timestamp"}'::jsonb, 'getQuantitiveValuation', 'getCurrentPrice', '2025-12-04 11:48:24+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-analyst-estimates', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/analyst-estimates?symbol={ticker}&period=quarter&page=0&limit=100&apikey={apiKey}', '{"date":"date","epsAvg":"epsAvg","epsLow":"epsLow","ticker":"symbol","ebitAvg":"ebitAvg","ebitLow":"ebitLow","epsHigh":"epsHigh","ebitHigh":"ebitHigh","ebitdaAvg":"ebitdaAvg","ebitdaLow":"ebitdaLow","ebitdaHigh":"ebitdaHigh","revenueAvg":"revenueAvg","revenueLow":"revenueLow","revenueHigh":"revenueHigh","netIncomeAvg":"netIncomeAvg","netIncomeLow":"netIncomeLow","netIncomeHigh":"netIncomeHigh","sgaExpenseAvg":"sgaExpenseAvg","sgaExpenseLow":"sgaExpenseLow","numAnalystsEps":"numAnalystsEps","sgaExpenseHigh":"sgaExpenseHigh","numAnalystsRevenue":"numAnalystsRevenue"}'::jsonb, 'getQuantitiveValuation', 'getAnalystEstimates', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-balance-sheet-statement', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/balance-sheet-statement?symbol={ticker}&period=quarter&limit=100&apikey={apiKey}', '{"date":"date","ticker":"symbol","netDebt":"netDebt","totalDebt":"totalDebt","filingDate":"filingDate","acceptedDate":"acceptedDate","retainedEarnings":"retainedEarnings","totalLiabilities":"totalLiabilities","totalCurrentAssets":"totalCurrentAssets","shortTermInvestments":"shortTermInvestments","cashAndCashEquivalents":"cashAndCashEquivalents","additionalPaidInCapital":"additionalPaidInCapital","totalCurrentLiabilities":"totalCurrentLiabilities","totalStockholdersEquity":"totalStockholdersEquity","otherNonCurrentLiabilities":"otherNonCurrentLiabilities","cashAndShortTermInvestments":"cashAndShortTermInvestments"}'::jsonb, 'getQuantitiveValuation', 'getBalanceSheetStatement', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-company-screener', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/company-screener?country=US&exchange=NYSE,NASDAQ,AMEX&isEtf=false&isFund=false&isActivelyTrading=true&limit=30000&apikey={apiKey}', '{"beta":"beta","isEtf":"isEtf","price":"price","isFund":"isFund","sector":"sector","ticker":"symbol","volume":"volume","country":"country","exchange":"exchange","industry":"industry","marketCap":"marketCap","companyName":"companyName","exchangeShortName":"exchangeShortName","isActivelyTrading":"isActivelyTrading","lastAnnualDividend":"lastAnnualDividend"}'::jsonb, 'sourceData', 'ticker', '2025-12-04 09:37:13+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-earnings-calendar', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/earnings-calendar?from={fromDate}&to={toDate}&apikey={apiKey}', '{"date":"date","ticker":"symbol","epsActual":"epsActual","lastUpdated":"lastUpdated","epsEstimated":"epsEstimated","revenueActual":"revenueActual","revenueEstimated":"revenueEstimated"}'::jsonb, 'sourceData', 'earningCalendar', '2025-12-04 11:19:12+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-grades', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/grades?symbol={ticker}&apikey={apiKey}', '{"date":"date","action":"action","ticker":"symbol","newGrade":"newGrade","previousGrade":"previousGrade","gradingCompany":"gradingCompany"}'::jsonb, 'getQualativeValuation, getEvent', 'getEachGradingConsensusLatestChanged', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-grades-consensus', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/grades-consensus?symbol={ticker}&apikey={apiKey}', '{"buy":"buy","hold":"hold","sell":"sell","ticker":"symbol","consensus":"consensus","strongBuy":"strongBuy","strongSell":"strongSell"}'::jsonb, 'getQualativeValuation', 'consensusSignal', '2025-12-10 13:27:28.754656+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-historical-price-eod-full', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/historical-price-eod/full?symbol={ticker}&from={fromDate}&to={toDate}&apikey={apiKey}', '{"low":"low","date":"date","high":"high","open":"open","vwap":"vwap","close":"close","change":"change","ticker":"symbol","volume":"volume","priceEodLow":"low","priceEodHigh":"high","priceEodOpen":"open","changePercent":"changePercent","priceEodClose":"close"}'::jsonb, 'getQuantitiveValuation', 'getLastPrice', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-holidays-by-exchange', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/holidays-by-exchange?exchange=NASDAQ&apikey={apiKey}', '{"date":"date","name":"name","exchange":"exchange","isClosed":"isClosed","adjOpenTime":"adjOpenTime","adjCloseTime":"adjCloseTime","isFullyClosed":"isFullyClosed"}'::jsonb, 'sourceData', 'marketHour', '2025-12-05 01:21:18+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-income-statement', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/income-statement?symbol={ticker}&period=quarter&limit=100&apikey={apiKey}', '{"eps":"eps","date":"date","ebitda":"ebitda","ticker":"symbol","revenue":"revenue","netIncome":"netIncome","filingDate":"filingDate","grossProfit":"grossProfit","acceptedDate":"acceptedDate","operatingIncome":"operatingIncome","operatingExpenses":"operatingExpenses","weightedAverageShsOut":"weightedAverageShsOut","totalOtherIncomeExpensesNet":"totalOtherIncomeExpensesNet","researchAndDevelopmentExpenses":"researchAndDevelopmentExpenses","nonOperatingIncomeExcludingInterest":"nonOperatingIncomeExcludingInterest"}'::jsonb, 'getQuantitiveValuation', 'getIncomeStatement', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-is-market-open', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/exchange-market-hours?exchange=NASDAQ&apikey={apiKey}', '{"name":"name","exchange":"exchange","timezone":"timezone","closingHour":"closingHour","openingHour":"openingHour","isMarketOpen":"isMarketOpen"}'::jsonb, 'target', 'isMarketOpen', '2025-12-08 09:41:34+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-price-target', 'financialmodelingprep', 'https://financialmodelingprep.com/api/v4/price-target?symbol={ticker}&apikey={apiKey}', '{"ticker":"symbol","newsURL":"newsURL","newsTitle":"newsTitle","event_date":"publishedDate","analystName":"analystName","newsBaseURL":"newsBaseURL","priceTarget":"priceTarget","newsPublisher":"newsPublisher","publishedDate":"publishedDate","adjPriceTarget":"adjPriceTarget","analystCompany":"analystCompany","priceWhenPosted":"priceWhenPosted"}'::jsonb, 'sourceData', 'getEachPriceTargetConsensus', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-price-target-analyst-name', 'financialmodelingprep', 'https://financialmodelingprep.com/api/v4/price-target-analyst-name?name={ANALYST_NAME}&apikey={apiKey}', '{"ticker":"symbol","newsURL":"newsURL","newsTitle":"newsTitle","analystName":"analystName","newsBaseURL":"newsBaseURL","priceTarget":"priceTarget","newsPublisher":"newsPublisher","publishedDate":"publishedDate","adjPriceTarget":"adjPriceTarget","analystCompany":"analystCompany","priceWhenPosted":"priceWhenPosted"}'::jsonb, 'getQualativeValuation', 'analystRating', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-price-target-consensus', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/price-target-consensus?symbol={ticker}&apikey={apiKey}', '{"ticker":"symbol","targetLow":"targetLow","targetHigh":"targetHigh","targetMedian":"targetMedian","targetConsensus":"targetConsensus"}'::jsonb, 'getQualativeValuation', 'getPriceTargetConsensus', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-price-target-latest-news', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/price-target-latest-news?page=0&limit=100&apikey={apiKey}', '{"ticker":"symbol","newsURL":"newsURL","newsTitle":"newsTitle","analystName":"analystName","newsBaseURL":"newsBaseURL","priceTarget":"priceTarget","newsPublisher":"newsPublisher","publishedDate":"publishedDate","adjPriceTarget":"adjPriceTarget","analystCompany":"analystCompany","priceWhenPosted":"priceWhenPosted"}'::jsonb, 'getQualativeValuation', 'getEachPriceTargetConsensusLatest', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-price-target-summary', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/price-target-summary?symbol={ticker}&apikey={apiKey}', '{"ticker":"symbol","publishers":"publishers","allTimeCount":"allTimeCount","lastYearCount":"lastYearCount","lastMonthCount":"lastMonthCount","lastQuarterCount":"lastQuarterCount","allTimeAvgPriceTarget":"allTimeAvgPriceTarget","lastYearAvgPriceTarget":"lastYearAvgPriceTarget","lastMonthAvgPriceTarget":"lastMonthAvgPriceTarget","lastQuarterAvgPriceTarget":"lastQuarterAvgPriceTarget"}'::jsonb, 'getQualativeValuation', 'getEachPriceTargetConsensusSummary', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-quote', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/quote?symbol={ticker}&apikey={apiKey}', '{"ticker":"symbol","marketCap":"marketCap","UTCtimestamp":"timestamp","priceRegular":"price"}'::jsonb, 'getQuantitiveValuation', 'marketCap', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-stock-latest', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/news/stock-latest?limit=1000&apikey={apiKey}', '{"url":"url","site":"site","text":"text","image":"image","title":"title","ticker":"symbol","publisher":"publisher","publishedDate":"publishedDate"}'::jsonb, 'news', 'stockLatest', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;
INSERT INTO public.config_lv1_api_list (id, api_service, api, schema, endpoint, function2, created_at) VALUES ('fmp-stock-peers', 'financialmodelingprep', 'https://financialmodelingprep.com/stable/stock-peers?symbol={ticker}&apikey={apiKey}', '{"ticker":"symbol","peerTickers":{"type":"array","items":{"price":{"type":"number","value":"price"},"mktCap":{"type":"number","value":"mktCap"},"symbol":{"type":"string","value":"symbol"},"companyName":{"type":"string","value":"companyName"}},"value":"peerTickers"}}'::jsonb, 'peer', 'getPeerTicker', '2025-12-04 12:06:22.973746+00') ON CONFLICT (id) DO UPDATE SET api_service=EXCLUDED.api_service, api=EXCLUDED.api, schema=EXCLUDED.schema, endpoint=EXCLUDED.endpoint, function2=EXCLUDED.function2;

-- 3) Metric transforms
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('emitReturnSeriesFromEvents', 'aggregation', '이벤트 데이터를 기반으로 수익률 시계열 생성', 'event_list', 'quarter_series', '{}'::jsonb, '{"dayOffsetKey":"dayOffset","closeKey":"price_trend.close","baseKey":"value_qualitative.consensusSignal.last.price_when_posted","emitKey":"return","formula":"(close / base) - 1","ignoreNull":true}'::jsonb, 1, TRUE, now()) ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('avgFromQuarter', 'aggregation', '분기 시계열 평균', 'quarter_series', 'scalar', '{}'::jsonb, '{"order":"desc","window":4}'::jsonb, 1, TRUE, '2025-12-05 08:00:17.106953+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('confidenceIntervalByDayOffset', 'aggregation', 'Group base metric by dayOffset and compute mean confidence interval', 'quarter_series', 'scalar', '{}'::jsonb, '{"z":1.96,"use":"z","level":0.95,"groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true}'::jsonb, 1, TRUE, '2025-12-09 08:40:17.987008+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('lastFromQuarter', 'aggregation', '분기 시계열에서 가장 최신 1개 값을 반환', 'quarter_series', 'scalar', '{}'::jsonb, '{}'::jsonb, 1, TRUE, '2025-12-05 06:43:51.05452+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('leadPairFromList', 'aggregation', 'PartitionBy + OrderBy 기반으로 리스트를 정렬한 뒤 lead(=더 과거 인접행) 값을 각 row에 붙여 last/prev 비교가 가능하도록 만든다.', 'row_list', 'row_list', '{"type":"object","required":["partitionBy","orderBy","leadFields"],"properties":{"orderBy":{"type":"array","items":{"type":"object","additionalProperties":{"type":"string"}}},"leadFields":{"type":"array","items":{"type":"object","required":["field","as"],"properties":{"as":{"type":"string"},"field":{"type":"string"}}}},"emitPrevRow":{"type":"boolean"},"partitionBy":{"type":"array","items":{"type":"string"}}}}'::jsonb, '{"orderBy":[{"publishedDate":"desc"}],"leadFields":[{"as":"priceTarget_prev","field":"priceTarget"},{"as":"priceWhenPosted_prev","field":"priceWhenPosted"}],"emitPrevRow":true,"partitionBy":["ticker","analystName","analystCompany"]}'::jsonb, 1, TRUE, '2025-12-15 04:41:11+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('proficiencyRateByDayOffset', 'aggregation', 'Group base metric by dayOffset and compute rate >= cutScore', 'quarter_series', 'scalar', '{}'::jsonb, '{"groupBy":["analyst_name","analyst_company","dayOffset"],"cutScore":60,"valueKey":"close","direction":"gte","ignoreNull":true}'::jsonb, 1, TRUE, '2025-12-09 08:40:17.987008+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('qoqFromQuarter', 'aggregation', '전분기 대비 증감률(QoQ)', 'quarter_series', 'scalar', '{}'::jsonb, '{"order":"desc"}'::jsonb, 1, TRUE, '2025-12-05 08:00:17.106953+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('statsByDayOffset', 'aggregation', 'Group base metric by analyst_name+analyst_company+dayOffset and compute stats', 'quarter_series', 'scalar', '{}'::jsonb, '{"stat":"mean","groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true}'::jsonb, 1, TRUE, '2025-12-09 08:40:17.987008+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('ttmFromQuarterSumOrScaled', 'aggregation', '최근 최대 4분기 합산 TTM. 데이터 부족 시 (sum/n)*4로 환산', 'quarter_series', 'scalar', '{}'::jsonb, '{}'::jsonb, 1, TRUE, '2025-12-05 06:43:51.05452+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;
INSERT INTO public.config_lv2_metric_transform (id, transform_type, description, input_kind, output_kind, params_schema, example_params, version, is_active, created_at) VALUES ('yoyFromQuarter', 'aggregation', '전년동기 대비 증감률(YoY)', 'quarter_series', 'scalar', '{}'::jsonb, '{"order":"desc"}'::jsonb, 1, TRUE, '2025-12-05 08:00:17.106953+00') ON CONFLICT (id) DO UPDATE SET transform_type=EXCLUDED.transform_type, description=EXCLUDED.description, input_kind=EXCLUDED.input_kind, output_kind=EXCLUDED.output_kind, params_schema=EXCLUDED.params_schema, example_params=EXCLUDED.example_params, version=EXCLUDED.version, is_active=EXCLUDED.is_active;

-- 4) Metrics
-- Base metrics (api_field) first to satisfy foreign key dependencies
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('additionalPaidInCapital', 'base field from fmp-balance-sheet-statement', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 07:43:43.808499+00', NULL, '"additionalPaidInCapital"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('cashAndCashEquivalents', '현금성자산(분기)', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 06:15:30.060189+00', NULL, '"cashAndCashEquivalents"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('cashAndShortTermInvestments', 'base field from fmp-balance-sheet-statement', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"cashAndShortTermInvestments"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('consensus', '애널리스트별 목표가 변경 시그널', 'api_field', 'fmp-price-target', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-10 13:58:19.636623+00', NULL, '{"ticker":"symbol","newsURL":"newsURL","newsTitle":"newsTitle","analystName":"analystName","newsBaseURL":"newsBaseURL","priceTarget":"priceTarget","newsPublisher":"newsPublisher","publishedDate":"publishedDate","adjPriceTarget":"adjPriceTarget","analystCompany":"analystCompany","priceWhenPosted":"priceWhenPosted"}'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('consensusSummary', '애널리스트 평균 목표가', 'api_field', 'fmp-price-target-consensus', NULL, NULL, '{}'::jsonb, NULL, 'qualatative-consensusSummary', '2025-12-10 05:50:15.289707+00', NULL, '{"ticker":"symbol","targetLow":"targetLow","targetHigh":"targetHigh","targetMedian":"targetMedian","targetConsensus":"targetConsensus"}'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('ebitda', 'base field from fmp-income-statement', 'api_field', 'fmp-income-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"ebitda"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('grossProfit', 'base field from fmp-income-statement', 'api_field', 'fmp-income-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"grossProfit"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('isMarketOpen', NULL, 'api_field', 'fmp-is-market-open', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-08 09:43:41+00', NULL, '"isMarketOpen"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('marketCap', '시가총액', 'api_field', 'fmp-quote', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 06:15:30.060189+00', NULL, '"marketCap"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('netDebt', 'base field from fmp-balance-sheet-statement', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"netDebt"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('netIncome', '순이익(분기)', 'api_field', 'fmp-income-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 06:15:30.060189+00', NULL, '"netIncome"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('operatingIncome', 'base field from fmp-income-statement', 'api_field', 'fmp-income-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"operatingIncome"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('otherNonCurrentLiabilities', 'base field from fmp-balance-sheet-statement', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"otherNonCurrentLiabilities"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceAfter', NULL, 'api_field', 'fmp-aftermarket-trade', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-08 09:35:47+00', '$.priceAfter', '"priceAfter"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodOHLC', 'EOD OHLC 번들', 'api_field', 'fmp-historical-price-eod-full', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-09 01:03:58.482578+00', NULL, '{"low":"low","high":"high","open":"open","close":"close"}'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceRegular', '주가', 'api_field', 'fmp-quote', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:27:18+00', NULL, '"priceRegular"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('researchAndDevelopmentExpenses', 'base field from fmp-income-statement', 'api_field', 'fmp-income-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"researchAndDevelopmentExpenses"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('revenue', '매출(분기)', 'api_field', 'fmp-income-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 06:15:30.060189+00', NULL, '"revenue"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('totalCurrentAssets', 'base field from fmp-balance-sheet-statement', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"totalCurrentAssets"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('totalCurrentLiabilities', 'base field from fmp-balance-sheet-statement', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"totalCurrentLiabilities"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('totalDebt', '총부채(분기)', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 06:15:30.060189+00', NULL, '"totalDebt"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('totalStockholdersEquity', '자기자본(분기)', 'api_field', 'fmp-balance-sheet-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 06:15:30.060189+00', NULL, '"totalStockholdersEquity"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('weightedAverageShsOut', 'base field from fmp-income-statement', 'api_field', 'fmp-income-statement', NULL, NULL, '{}'::jsonb, NULL, 'internal', '2025-12-05 08:00:33.41798+00', NULL, '"weightedAverageShsOut"'::jsonb) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;

-- Derived metrics (aggregation and expression)
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('apicYoY', 'yoyFromQuarter of additionalPaidInCapital', 'aggregation', NULL, 'additionalPaidInCapital', 'yoyFromQuarter', '{"order":"desc"}'::jsonb, NULL, 'quantitative-dilution', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('avgNetDebt', 'avgFromQuarter of netDebt', 'aggregation', NULL, 'netDebt', 'avgFromQuarter', '{"order":"desc"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('avgOtherNCL', 'avgFromQuarter of otherNonCurrentLiabilities', 'aggregation', NULL, 'otherNonCurrentLiabilities', 'avgFromQuarter', '{"order":"desc"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('avgTotalDebt', 'avgFromQuarter of totalDebt', 'aggregation', NULL, 'totalDebt', 'avgFromQuarter', '{"order":"desc"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('avgTotalEquity', 'avgFromQuarter of totalStockholdersEquity', 'aggregation', NULL, 'totalStockholdersEquity', 'avgFromQuarter', '{"order":"desc"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('cashAndCashEquivalentsLatest', 'lastFromQuarter of cashAndCashEquivalents', 'aggregation', NULL, 'cashAndCashEquivalents', 'lastFromQuarter', '{"limit":1,"order":"desc","fallback":"null"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('cashAndShortTermInvestmentsLast', 'lastFromQuarter of cashAndShortTermInvestments', 'aggregation', NULL, 'cashAndShortTermInvestments', 'lastFromQuarter', '{"limit":1,"order":"desc","fallback":"null"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('cashToRevenueTTM', NULL, 'expression', NULL, NULL, NULL, '{}'::jsonb, 'cashAndShortTermInvestmentsLast / revenueTTM', 'quantitative-risk', '2025-12-08 01:08:24+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('consensusSignal', 'consensusWithPrev(lead 적용된 레코드)에서 최신 last/prev를 선택하고 direction/delta/deltaPct 및 meta를 구성하여 value_qualitative.consensusSignal 출력 포맷(JSON)을 생성한다.', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'buildConsensusSignal(consensusWithPrev)', 'qualatative-consensusSignal', '2025-12-15 04:42:45.63725+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('consensusWithPrev', 'fmp-price-target(=consensus) 레코드를 (ticker, analystName, analystCompany) 파티션으로 publishedDate DESC 정렬 후 lead(더 과거 인접행) 값을 붙여 prev 비교가 가능하도록 만든다.', 'aggregation', NULL, 'consensus', 'leadPairFromList', '{"orderBy":[{"publishedDate":"desc"}],"leadFields":[{"as":"priceTarget_prev","field":"priceTarget"},{"as":"priceWhenPosted_prev","field":"priceWhenPosted"}],"emitPrevRow":true,"partitionBy":["ticker","analystName","analystCompany"]}'::jsonb, NULL, 'internal', '2025-12-15 04:42:45.63725+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('currentRatio', '유동비율 = 유동자산 / 유동부채', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'totalCurrentAssetsLast / totalCurrentLiabilitiesLast', 'quantitative-risk', '2025-12-08 01:08:59+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('debtToEquityAvg', '평균 부채비율 = 평균 총부채 / 평균 자기자본', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'avgTotalDebt / avgTotalEquity', 'quantitative-dilution', '2025-12-08 00:58:52+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('ebitdaTTM', 'ttmFromQuarterSumOrScaled of ebitda', 'aggregation', NULL, 'ebitda', 'ttmFromQuarterSumOrScaled', '{"mode":"sum_or_scaled","order":"desc","window":4,"scale_to":4,"min_points":1}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('enterpriseValue', '기업가치(EV) 근사', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'marketCap + totalDebtLatest - cashAndCashEquivalentsLatest', 'internal', '2025-12-05 06:16:06.491405+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('equityLatest', '자기자본 최신분기', 'aggregation', NULL, 'totalStockholdersEquity', 'lastFromQuarter', '{"limit":1,"order":"desc","fallback":"null"}'::jsonb, NULL, 'internal', '2025-12-05 06:15:33.71188+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('evEBITDA', NULL, 'expression', NULL, NULL, NULL, '{}'::jsonb, 'enterpriseValue / ebitdaTTM', 'quantitative-valuation', '2025-12-08 01:13:05+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('grossMarginLast', '최근 분기 매출총이익률 = grossProfit / revenue', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'grossProfitLast / revenueLast', 'quantitative-momentum', '2025-12-08 01:05:04.572783+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('grossMarginTTM', 'TTM 매출총이익률 = grossProfitTTM / revenueTTM', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'grossProfitTTM / revenueTTM', 'quantitative-momentum', '2025-12-08 01:05:28.636498+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('grossProfitLast', 'lastFromQuarter of grossProfit', 'aggregation', NULL, 'grossProfit', 'lastFromQuarter', '{"limit":1,"order":"desc","fallback":"null"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('grossProfitTTM', 'ttmFromQuarterSumOrScaled of grossProfit', 'aggregation', NULL, 'grossProfit', 'ttmFromQuarterSumOrScaled', '{"mode":"sum_or_scaled","order":"desc","window":4,"scale_to":4,"min_points":1}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('netdebtToEquityAvg', '순부채 / 자기자본 (최근 4분기 평균)', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'avgNetDebt / avgTotalEquity', 'quantitative-risk', '2025-12-08 01:01:46+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('netIncomeTTM', '순이익 TTM', 'aggregation', NULL, 'netIncome', 'ttmFromQuarterSumOrScaled', '{"mode":"sum_or_scaled","order":"desc","window":4,"scale_to":4,"min_points":1}'::jsonb, NULL, 'internal', '2025-12-05 06:15:33.71188+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('operatingIncomeTTM', 'ttmFromQuarterSumOrScaled of operatingIncome', 'aggregation', NULL, 'operatingIncome', 'ttmFromQuarterSumOrScaled', '{"mode":"sum_or_scaled","order":"desc","window":4,"scale_to":4,"min_points":1}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('operatingMarginTTM', 'TTM 영업이익률 = operatingIncomeTTM / revenueTTM', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'operatingIncomeTTM / revenueTTM', 'quantitative-momentum', '2025-12-08 01:05:53+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('othernclToEquityAvg', '기타 비유동부채 / 자기자본 (최근 4분기 평균)', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'avgOtherNCL / avgTotalEquity', 'quantitative-dilution', '2025-12-08 01:04:36.484567+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('PBR', NULL, 'expression', NULL, NULL, NULL, '{}'::jsonb, 'marketCap / equityLatest', 'quantitative-valuation', '2025-12-08 01:14:59+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('PER', NULL, 'expression', NULL, NULL, NULL, '{}'::jsonb, 'marketCap / netIncomeTTM', 'quantitative-valuation', '2025-12-08 01:15:17+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('price', NULL, 'expression', NULL, NULL, NULL, '{}'::jsonb, 'if isMarketOpen then priceRegular else priceAfter', 'internal', '2025-12-08 09:46:52+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseCI95ByDayOffset', '95% confidence interval of mean of priceEodOHLC.close by dayOffset', 'aggregation', NULL, 'priceEodOHLC', 'confidenceIntervalByDayOffset', '{"z":1.96,"use":"z","level":0.95,"groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseCountByDayOffset', 'count of priceEodOHLC.close grouped by analyst_name+analyst_company+dayOffset', 'aggregation', NULL, 'priceEodOHLC', 'statsByDayOffset', '{"stat":"count","groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseFirstQuartileByDayOffset', 'first quartile(p25) of priceEodOHLC.close grouped by analyst_name+analyst_company+dayOffset', 'aggregation', NULL, 'priceEodOHLC', 'statsByDayOffset', '{"stat":"p25","groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true,"quantileMethod":"linear"}'::jsonb, NULL, 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseIQRByDayOffset', 'interquartile range of priceEodOHLC.close by dayOffset (p75 - p25)', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'priceEodCloseThirdQuartileByDayOffset - priceEodCloseFirstQuartileByDayOffset', 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseMeanByDayOffset', 'mean of priceEodOHLC.close grouped by analyst_name+analyst_company+dayOffset', 'aggregation', NULL, 'priceEodOHLC', 'statsByDayOffset', '{"stat":"mean","groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseMedianByDayOffset', 'median of priceEodOHLC.close grouped by analyst_name+analyst_company+dayOffset', 'aggregation', NULL, 'priceEodOHLC', 'statsByDayOffset', '{"stat":"median","groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseProficiencyRateByDayOffset', 'rate of priceEodOHLC.close >= cutScore grouped by analyst_name+analyst_company+dayOffset', 'aggregation', NULL, 'priceEodOHLC', 'proficiencyRateByDayOffset', '{"groupBy":["analyst_name","analyst_company","dayOffset"],"cutScore":60,"valueKey":"close","direction":"gte","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseStdDevByDayOffset', 'sample standard deviation of priceEodOHLC.close grouped by analyst_name+analyst_company+dayOffset', 'aggregation', NULL, 'priceEodOHLC', 'statsByDayOffset', '{"stat":"stddev_samp","groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceEodCloseThirdQuartileByDayOffset', 'third quartile(p75) of priceEodOHLC.close grouped by analyst_name+analyst_company+dayOffset', 'aggregation', NULL, 'priceEodOHLC', 'statsByDayOffset', '{"stat":"p75","groupBy":["analyst_name","analyst_company","dayOffset"],"valueKey":"close","ignoreNull":true,"quantileMethod":"linear"}'::jsonb, NULL, 'internal(qual)', '2025-12-09 08:40:17.987008+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceQualitative', NULL, 'expression', NULL, NULL, NULL, '{}'::jsonb, 'consensus.targetMedian', 'qualatative-targetMedian', '2025-12-10 13:12:46.902778+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('PSR', NULL, 'expression', NULL, NULL, NULL, '{}'::jsonb, 'marketCap / revenueTTM', 'quantitative-valuation', '2025-12-08 01:15:42+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('revenueLast', 'lastFromQuarter of revenue', 'aggregation', NULL, 'revenue', 'lastFromQuarter', '{"limit":1,"order":"desc","fallback":"null"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('revenueQoQ', 'qoqFromQuarter of revenue', 'aggregation', NULL, 'revenue', 'qoqFromQuarter', '{"order":"desc"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('revenueTTM', '매출 TTM', 'aggregation', NULL, 'revenue', 'ttmFromQuarterSumOrScaled', '{"mode":"sum_or_scaled","order":"desc","window":4,"scale_to":4,"min_points":1}'::jsonb, NULL, 'internal', '2025-12-05 06:15:33.71188+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('revenueYoY', 'yoyFromQuarter of revenue', 'aggregation', NULL, 'revenue', 'yoyFromQuarter', '{"order":"desc"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('rndIntensityTTM', '기술 투자 비율 = R&D 비용(TTM) / 매출(TTM)', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'rndTTM / revenueTTM', 'quantitative-momentum', '2025-12-08 01:06:24+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('rndTTM', 'ttmFromQuarterSumOrScaled of researchAndDevelopmentExpenses', 'aggregation', NULL, 'researchAndDevelopmentExpenses', 'ttmFromQuarterSumOrScaled', '{"mode":"sum_or_scaled","order":"desc","window":4,"scale_to":4,"min_points":1}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('ROE', NULL, 'expression', NULL, NULL, NULL, '{}'::jsonb, 'netIncomeTTM / avgTotalEquity', 'quantitative-profitability', '2025-12-08 01:06:51+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('runwayYears', '현금 및 단기투자자산 / |영업이익(TTM)|. 영업이익이 플러스면 null 반환.', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'if operatingIncomeTTM >= 0 then null else cashAndShortTermInvestmentsLast / abs(operatingIncomeTTM)', 'quantitative-risk', '2025-12-08 01:09:48.30796+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('sharesYoY', 'yoyFromQuarter of weightedAverageShsOut', 'aggregation', NULL, 'weightedAverageShsOut', 'yoyFromQuarter', '{"order":"desc"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('totalCurrentAssetsLast', 'lastFromQuarter of totalCurrentAssets', 'aggregation', NULL, 'totalCurrentAssets', 'lastFromQuarter', '{"limit":1,"order":"desc","fallback":"null"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('totalCurrentLiabilitiesLast', 'lastFromQuarter of totalCurrentLiabilities', 'aggregation', NULL, 'totalCurrentLiabilities', 'lastFromQuarter', '{"limit":1,"order":"desc","fallback":"null"}'::jsonb, NULL, 'internal', '2025-12-05 08:54:29.559047+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('totalDebtLatest', '총부채 최신분기', 'aggregation', NULL, 'totalDebt', 'lastFromQuarter', '{"limit":1,"order":"desc","fallback":"null"}'::jsonb, NULL, 'internal', '2025-12-05 06:15:33.71188+00', NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;

INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('priceTrendReturnSeries', 'build per-event dayOffset return series: (close / price_when_posted) - 1', 'aggregation', NULL, NULL, 'emitReturnSeriesFromEvents', '{"dayOffsetKey":"dayOffset","closeKey":"price_trend.close","baseKey":"value_qualitative.consensusSignal.last.price_when_posted","emitKey":"return","formula":"(close / base) - 1","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', now(), NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('returnMeanByDayOffset', 'mean of return by analyst and dayOffset', 'aggregation', NULL, 'priceTrendReturnSeries', 'statsByDayOffset', '{"stat":"mean","valueKey":"return","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', now(), NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('returnMedianByDayOffset', 'median of return by analyst and dayOffset', 'aggregation', NULL, 'priceTrendReturnSeries', 'statsByDayOffset', '{"stat":"median","valueKey":"return","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', now(), NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('returnFirstQuartileByDayOffset', 'first quartile(p25) of return by analyst and dayOffset', 'aggregation', NULL, 'priceTrendReturnSeries', 'statsByDayOffset', '{"stat":"p25","valueKey":"return","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', now(), NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('returnThirdQuartileByDayOffset', 'third quartile(p75) of return by analyst and dayOffset', 'aggregation', NULL, 'priceTrendReturnSeries', 'statsByDayOffset', '{"stat":"p75","valueKey":"return","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', now(), NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('returnIQRByDayOffset', 'interquartile range(p75-p25) of return by dayOffset', 'expression', NULL, NULL, NULL, '{}'::jsonb, 'returnThirdQuartileByDayOffset - returnFirstQuartileByDayOffset', 'internal(qual)', now(), NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('returnStdDevByDayOffset', 'sample standard deviation of return by dayOffset', 'aggregation', NULL, 'priceTrendReturnSeries', 'statsByDayOffset', '{"stat":"stddev_samp","valueKey":"return","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', now(), NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;
INSERT INTO public.config_lv2_metric (id, description, source, api_list_id, base_metric_id, aggregation_kind, aggregation_params, expression, domain, created_at, response_path, response_key) VALUES ('returnCountByDayOffset', 'count of return samples by dayOffset', 'aggregation', NULL, 'priceTrendReturnSeries', 'statsByDayOffset', '{"stat":"count","valueKey":"return","ignoreNull":true}'::jsonb, NULL, 'internal(qual)', now(), NULL, NULL) ON CONFLICT (id) DO UPDATE SET description=EXCLUDED.description, source=EXCLUDED.source, api_list_id=EXCLUDED.api_list_id, base_metric_id=EXCLUDED.base_metric_id, aggregation_kind=EXCLUDED.aggregation_kind, aggregation_params=EXCLUDED.aggregation_params, expression=EXCLUDED.expression, domain=EXCLUDED.domain, response_path=EXCLUDED.response_path, response_key=EXCLUDED.response_key;


-- 5) Policies
INSERT INTO public.config_lv0_policy (endpoint, function, description, policy, created_at) VALUES ('fillPriceTrend', 'fillPriceTrend_dateRange', '엔드포인트의 가격 이력 수집 범위', '{"countEnd":14,"countStart":-14}'::jsonb, '2025-12-09 05:38:37+00') ON CONFLICT (function) DO UPDATE SET endpoint=EXCLUDED.endpoint, description=EXCLUDED.description, policy=EXCLUDED.policy;
INSERT INTO public.config_lv0_policy (endpoint, function, description, policy, created_at) VALUES ('sourceData', 'sourceData_dateRange', '엔드포인트의 자동 업데이트 기간', '{"getTarget":{"type":"cycle","value":7,"status":true},"getHoliday":{"type":"weekly","value":["MON","WED"],"status":true},"getConsensus":{"type":"cycle","value":1,"status":false}}'::jsonb, '2025-12-12 04:51:15.318216+00') ON CONFLICT (function) DO UPDATE SET endpoint=EXCLUDED.endpoint, description=EXCLUDED.description, policy=EXCLUDED.policy;

COMMIT;

-- ============================================================================
-- STEP 10: Verification Queries
-- ============================================================================

-- Run these queries to verify the setup
DO $$
DECLARE
    api_count int;
    policy_count int;
    target_count int;
    table_count int;
BEGIN
    SELECT COUNT(*) INTO api_count FROM config_lv1_api_service;
    SELECT COUNT(*) INTO policy_count FROM config_lv0_policy;
    SELECT COUNT(*) INTO target_count FROM config_lv3_targets;
    SELECT COUNT(*) INTO table_count FROM information_schema.tables
    WHERE table_schema = 'public' AND table_type = 'BASE TABLE';

    RAISE NOTICE '============================================================';
    RAISE NOTICE 'AlSign Database Setup Complete';
    RAISE NOTICE '============================================================';
    RAISE NOTICE 'API services: %', api_count;
    RAISE NOTICE 'Policies: %', policy_count;
    RAISE NOTICE 'Target tickers: %', target_count;
    RAISE NOTICE 'Total tables created: %', table_count;
    RAISE NOTICE '============================================================';
END $$;
-- List all created tables
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_type = 'BASE TABLE'
ORDER BY table_name;

